---
title: "Processing Env Predictor Variables for SDMs"
format: html
editor: visual
date: last-modified
editor_options: 
  chunk_output_type: console
---

```{r}
# clear the environment
rm(list = ls())
```

## Overview/Purpose

This script processes environmental predictor variables for use in species distribution models (SDMs). It will load each of the predictor variables in terra's `SpatRaster` format, ensure they are aligned to a common extent and resolution, and then export the processed rasters for use in modeling.

## Setup

#### Load packages

```{r}
# load required packages
library(terra)
library(here)
library(tidyverse)
library(tigris)
library(sf)
library(tmap)
```

#### Load data

###### BCM

```{r}
# ==============================================================================
# BCM historic data (30-year averages from 1991-2020)
# ==============================================================================

## AET
aet_rast <- rast(here("data/raw/bcm/BCMv8_1991_2020_aves/aet1991_2020_ave.asc"))
crs(aet_rast) <- "EPSG:3310" # assign correct CRS
# QC resolution & crs
res(aet_rast) # 270m resolution
crs(aet_rast) # EPSG:3310

## MAP
ppt_rast <- rast(here("data/raw/bcm/BCMv8_1991_2020_aves/ppt1991_2020_ave.asc"))
crs(ppt_rast) <- "EPSG:3310" # assign correct CRS
# QC resolution & crs
res(ppt_rast) # 270m resolution
crs(ppt_rast) # EPSG:3310

## CWD
cwd_rast <- rast(here("data/raw/bcm/BCMv8_1991_2020_aves/cwd1991_2020_ave.asc"))
crs(cwd_rast) <- "EPSG:3310" # assign correct CRS
# QC resolution & crs
res(cwd_rast) # 270m resolution
crs(cwd_rast) # EPSG:3310

## TMX
tmx_rast <- rast(here("data/raw/bcm/BCMv8_1991_2020_aves/tmx1991_2020_ave.asc"))
crs(tmx_rast) <- "EPSG:3310" # assign correct CRS
# QC resolution & crs
res(tmx_rast) # 270m resolution
crs(tmx_rast) # EPSG:3310

## TMN
tmn_rast <- rast(here("data/raw/bcm/BCMv8_1991_2020_aves/tmn1991_2020_ave.asc"))
crs(tmn_rast) <- "EPSG:3310" # assign correct CRS
# QC resolution & crs
res(tmn_rast) # 270m resolution
crs(tmn_rast) # EPSG:3310
```

###### gSSURGO

```{r}
# ==============================================================================
# gSSURGO
# ==============================================================================

# % clay
clay_path <- here("data/raw/gssurgo/processed/clay_pct_0_10cm_CA_270m.tif")
clay_rast <- rast(clay_path)

# % sand
sand_path <- here("data/raw/gssurgo/processed/sand_pct_0_10cm_CA_270m.tif")
sand_rast <- rast(sand_path)

# % silt
silt_path <- here("data/raw/gssurgo/processed/silt_pct_0_10cm_CA_270m.tif")
silt_rast <- rast(silt_path)

# pH
ph_path <- here("data/raw/gssurgo/processed/pH_0_10cm_CA_270m.tif")
ph_rast <- rast(ph_path)

# EC
ec_path <- here("data/raw/gssurgo/processed/ec_dS_m_0_10cm_CA_270m.tif")
ec_rast <- rast(ec_path)
```

###### Slope

```{r}
# ==============================================================================
# slope (open topography)
# ==============================================================================

# open topography limits the size of raster downloads
# we have separate elevation rasters for northern and southern CA

# northern CA elevation raster path
nCA_elevation_path <- here("data/raw/open_topography/output_nCA_USGS30m.tif")
nCA_elevation_rast <- rast(nCA_elevation_path)

# southern CA elevation raster path
sCA_elevation_path <- here("data/raw/open_topography/output_sCA_USGS30m.tif")
sCA_elevation_rast <- rast(sCA_elevation_path)
```

## Data Processing

#### Make SJV spat vector

```{r}
# # get California counties from Census TIGER/Line shapefiles
# ca_counties <- counties(state = "CA")
# 
# # define San Joaquin Valley counties
# sjv_counties <- c("San Joaquin", "Stanislaus", "Merced", "Madera", 
#                   "Fresno", "Kings", "Tulare", "Kern")
# 
# # filter and combine into one polygon
# sjv <- ca_counties %>%
#   filter(NAME %in% sjv_counties) %>%
#   st_union() %>% 
#   st_transform(crs = crs(aet_mean)) %>% # transform to aet raster CRS
#   vect() # convert to terra vector format
# 
# # crop AET mean raster to SJV extent
# aet_mean_sjv <- aet_mean %>% 
#   crop(sjv) %>%
#   mask(sjv)
# 
# # plot cropped AET raster
# plot(aet_mean_sjv, main = "Mean AET (SJV)")
```

#### Make CA boundary spat vector

```{r}
# get California state boundary from Census TIGER/Line shapefiles
ca_state <- states() %>%
  filter(NAME == "California") %>%
  st_transform(crs = crs(aet_rast)) %>% # transform to aet raster CRS
  vect() # convert to terra vector format
plot(ca_state, main = "California State Boundary")

# # transform to WGS84 for later use
# ca_state_wgs84 <- states() %>%
#   filter(NAME == "California") %>%
#   st_transform(crs = "EPSG:4326") %>% # transform to WGS84
#   vect() # convert to terra vector format
# plot(ca_state_wgs84, main = "California State Boundary (WGS84)")
# 
# # save CA boundary as WGS84
# writeVector(ca_state_wgs84, 
#             filename = here("data/raw/ca_state/ca_state_boundary_wgs84.shp"), 
#             overwrite = TRUE)
```

#### BCM

###### Crop `AET`, `CWD`, and `PPT` CA boundary

```{r}
# crop AET raster to CA boundary
aet_ca <- aet_rast %>%
  crop(ca_state) %>%
  mask(ca_state)

# view range of AET values in CA
summary(values(aet_ca))
# -9999 indicates no data values -- these should be NA
values(aet_ca)[values(aet_ca) == -9999] <- NA


# crop PPT raster to CA boundary
ppt_ca <- ppt_rast %>%
  crop(ca_state) %>%
  mask(ca_state)
# view range of PPT values in CA
summary(values(ppt_ca))
# -9999 indicates no data values -- these should be NA
values(ppt_ca)[values(ppt_ca) == -9999] <- NA


# crop CWD raster to CA boundary
cwd_ca <- cwd_rast %>%
  crop(ca_state) %>%
  mask(ca_state)
# view range of CWD values in CA
summary(values(cwd_ca))
# -9999 indicates no data values -- these should be NA
values(cwd_ca)[values(cwd_ca) == -9999] <- NA


# crop TMN raster to CA boundary
tmn_ca <- tmn_rast %>%
  crop(ca_state) %>%
  mask(ca_state)
# view range of TMN values in CA
summary(values(tmn_ca))
# -9999 indicates no data values -- these should be NA
values(tmn_ca)[values(tmn_ca) == -9999] <- NA


# crop TMX raster to CA boundary
tmx_ca <- tmx_rast %>%
  crop(ca_state) %>%
  mask(ca_state)
# view range of TMX values in CA
summary(values(tmx_ca))
# -9999 indicates no data values -- these should be NA
values(tmx_ca)[values(tmx_ca) == -9999] <- NA


# plot cropped rasters
plot(aet_ca, main = "AET (CA Boundary)")
plot(ppt_ca, main = "PPT (CA Boundary)")
plot(cwd_ca, main = "CWD (CA Boundary)")
plot(tmn_ca, main = "TMN (CA Boundary)")
plot(tmx_ca, main = "TMX (CA Boundary)")
```

###### Fill NA values in AET raster

The AET raster has some NA values in small areas. This causes errors in `Wallace`. We will fill these values with the mean value of neighboring cells.

```{r}
# define function to fill NA values with mean of neighboring cells
fill_all_na <- function(raster, max_iter = 100) {
  r <- raster
  for (i in 1:max_iter) {
    if (!any(is.na(values(r)))) break
    r <- focal(r, 
               w = 3,                # 3x3 moving window
               fun = mean, 
               na.rm = TRUE,         # ignore NAs in calculation
               na.policy = "only")   # only replace NA cells, leave others as is
  }
  return(r)
}

## AET
# apply function to AET raster
aet_ca_filled <- fill_all_na(aet_ca)

# crop to PPT to ensure no edge effects
aet_ca_filled <- aet_ca_filled %>%
  crop(ppt_ca) %>%
  mask(ppt_ca)

# resample ppt to match aet extent
ppt_ca <- resample(ppt_ca, 
                   aet_ca_filled, 
                   method = "mean")


## CWD
# apply function to CWD raster
cwd_ca_filled <- fill_all_na(cwd_ca)

# crop to PPT to ensure no edge effects
cwd_ca_filled <- cwd_ca_filled %>%
  crop(ppt_ca) %>%
  mask(ppt_ca)

# resample cwd to match aet extent
cwd_ca_filled <- resample(cwd_ca_filled, 
                          aet_ca_filled, 
                          method = "mean")


## TMN
# crop to PPT to ensure no edge effects
tmn_ca <- tmn_ca %>%
  crop(ppt_ca) %>%
  mask(ppt_ca)

# resample to match aet extent
tmn_ca <- resample(tmn_ca, 
                   aet_ca_filled, 
                   method = "mean")

## TMX
# crop to PPT to ensure no edge effects
tmx_ca <- tmx_ca %>%
  crop(ppt_ca) %>%
  mask(ppt_ca)

# resample to match aet extent
tmx_ca <- resample(tmx_ca, 
                   aet_ca_filled, 
                   method = "mean")


# QC make sure aet, cwd and ppt have same extent and resolution
crs(aet_ca_filled) == crs(ppt_ca)
ext(aet_ca_filled) == ext(ppt_ca)
res(aet_ca_filled) == res(ppt_ca)

crs(aet_ca_filled) == crs(cwd_ca_filled)
ext(aet_ca_filled) == ext(cwd_ca_filled)
res(aet_ca_filled) == res(cwd_ca_filled)

crs(aet_ca_filled) == crs(tmn_ca)
ext(aet_ca_filled) == ext(tmn_ca)
res(aet_ca_filled) == res(tmn_ca)

crs(aet_ca_filled) == crs(tmx_ca)
ext(aet_ca_filled) == ext(tmx_ca)
res(aet_ca_filled) == res(tmx_ca)

# plot final AET & CWD raster
plot(aet_ca_filled, main = "Mean AET (filled NA values)")
plot(cwd_ca_filled, main = "Mean CWD (filled NA values)")
```

#### gSSURGO

Resample gSSURGO rasters to match AET `ext`, `res`, and `crs`.

```{r}
# resample gSSURGO rasters to match AET
clay_resampled <- resample(clay_rast, 
                           aet_ca_filled, 
                           method = "mean")
sand_resampled <- resample(sand_rast, 
                           aet_ca_filled, 
                           method = "mean")
silt_resampled <- resample(silt_rast, 
                           aet_ca_filled, 
                           method = "mean")
ph_resampled <- resample(ph_rast, 
                         aet_ca_filled, 
                         method = "mean")
ec_resampled <- resample(ec_rast, 
                         aet_ca_filled, 
                         method = "mean")

# confirm all rasters have the same extent and resolution
crs(clay_resampled) == crs(aet_ca_filled)
crs(sand_resampled) == crs(aet_ca_filled)
crs(silt_resampled) == crs(aet_ca_filled)
crs(ph_resampled) == crs(aet_ca_filled)
crs(ec_resampled) == crs(aet_ca_filled)

ext(clay_resampled) == ext(aet_ca_filled)
ext(sand_resampled) == ext(aet_ca_filled)
ext(silt_resampled) == ext(aet_ca_filled)
ext(ph_resampled) == ext(aet_ca_filled)
ext(ec_resampled) == ext(aet_ca_filled)

res(clay_resampled) == res(aet_ca_filled)
res(sand_resampled) == res(aet_ca_filled)
res(silt_resampled) == res(aet_ca_filled)
res(ph_resampled) == res(aet_ca_filled)
res(ec_resampled) == res(aet_ca_filled)
```

The gSSURGO data has a lot of NA values in some areas. This causes errors in `Wallace`. We might fill these values with other data later, but for now we will fill them with the mean value of neighboring cells.

```{r}
# apply fill NA function to gSSURGO rasters
clay_filled <- fill_all_na(clay_resampled)
sand_filled <- fill_all_na(sand_resampled)
silt_filled <- fill_all_na(silt_resampled)
ph_filled <- fill_all_na(ph_resampled)
ec_filled <- fill_all_na(ec_resampled)

# crop to aet raster to ensure no edge effects
clay_filled <- clay_filled %>% 
  crop(aet_ca_filled) %>%
  mask(aet_ca_filled)
sand_filled <- sand_filled %>% 
  crop(aet_ca_filled) %>%
  mask(aet_ca_filled)
silt_filled <- silt_filled %>%
  crop(aet_ca_filled) %>%
  mask(aet_ca_filled)
ph_filled <- ph_filled %>% 
  crop(aet_ca_filled) %>%
  mask(aet_ca_filled)
ec_filled <- ec_filled %>% 
  crop(aet_ca_filled) %>%
  mask(aet_ca_filled)

# make sure all rasters have the same extent and resolution
crs(clay_filled) == crs(aet_ca_filled)
crs(sand_filled) == crs(aet_ca_filled)
crs(silt_filled) == crs(aet_ca_filled)
crs(ph_filled) == crs(aet_ca_filled)
crs(ec_filled) == crs(aet_ca_filled)

ext(clay_filled) == ext(aet_ca_filled)
ext(sand_filled) == ext(aet_ca_filled)
ext(silt_filled) == ext(aet_ca_filled)
ext(ph_filled) == ext(aet_ca_filled)
ext(ec_filled) == ext(aet_ca_filled)

res(clay_filled) == res(aet_ca_filled)
res(sand_filled) == res(aet_ca_filled)
res(silt_filled) == res(aet_ca_filled)
res(ph_filled) == res(aet_ca_filled)
res(ec_filled) == res(aet_ca_filled)

# plot filled gSSURGO rasters
plot(clay_filled, main = "% Clay (filled NA values)")
plot(sand_filled, main = "% Sand (filled NA values)")
plot(silt_filled, main = "% Silt (filled NA values)")
plot(ph_filled, main = "pH (filled NA values)")
plot(ec_filled, main = "EC (filled NA values)")
```

#### Slope

```{r}
# project elevation rasters to match AET
nCA_elevation_proj <- project(nCA_elevation_rast, 
                              aet_ca_filled, 
                              method = "mean")
crs(nCA_elevation_proj) # confirm EPSG:3310

sCA_elevation_proj <- project(sCA_elevation_rast, 
                              aet_ca_filled, 
                              method = "mean")
crs(sCA_elevation_proj) # confirm EPSG:3310  

# resample southern CA elevation to match northern CA elevation
sCA_elevation_resampled <- resample(sCA_elevation_proj, 
                                    nCA_elevation_proj, 
                                    method = "mean")


# merge northern and southern CA elevation rasters
elevation_merged <- terra::merge(nCA_elevation_proj, sCA_elevation_resampled)

# crop to CA
elevation_ca <- elevation_merged %>%
  crop(aet_ca_filled) %>%
  mask(aet_ca_filled)
plot(elevation_ca, main = "Elevation (CA Boundary)")


# calculate slope from elevation
slope_rast <- terrain(elevation_ca, 
                      v = "slope", 
                      unit = "degrees")

# resample to match AET resolution and extent
slope_resampled <- resample(slope_rast, 
                            aet_ca_filled, 
                            method = "mean")
plot(slope_resampled, main = "Elevation")


# confirm all rasters have the same extent and resolution
crs(slope_resampled) == crs(aet_ca_filled)
ext(slope_resampled) == ext(aet_ca_filled)
res(slope_resampled) == res(aet_ca_filled)
```

## Export Processed Rasters

#### EPSG:3310, 270m resolution, SJV extent

```{r}
# path to output directory
output_dir <- here("data/intermediate/misc/habitat_suitability/env_predictors/baseline")

# export AET raster
writeRaster(aet_ca_filled, 
            filename = file.path(output_dir, "aet1991_2020_ave_CA_270m.tif"), 
            overwrite = TRUE)

# export PPT raster
writeRaster(ppt_ca, 
            filename = file.path(output_dir, "ppt1991_2020_ave_CA_270m.tif"), 
            overwrite = TRUE)

# export CWD raster
writeRaster(cwd_ca_filled,
            filename = file.path(output_dir, "cwd1991_2020_ave_CA_270m.tif"), 
            overwrite = TRUE)

# export TMN raster
writeRaster(tmn_ca,
            filename = file.path(output_dir, "tmn1991_2020_ave_CA_270m.tif"), 
            overwrite = TRUE)

# export TMX raster
writeRaster(tmx_ca,
            filename = file.path(output_dir, "tmx1991_2020_ave_CA_270m.tif"), 
            overwrite = TRUE)


# export gSSURGO rasters
writeRaster(clay_filled, 
            filename = file.path(output_dir, "clay_pct_0_10cm_CA_270m.tif"), 
            overwrite = TRUE)
writeRaster(sand_filled, 
            filename = file.path(output_dir, "sand_pct_0_10cm_CA_270m.tif"), 
            overwrite = TRUE)
writeRaster(silt_filled, 
            filename = file.path(output_dir, "silt_pct_0_10cm_CA_270m.tif"), 
            overwrite = TRUE)
writeRaster(ph_filled, 
            filename = file.path(output_dir, "ph_0_10cm_CA_270m.tif"), 
            overwrite = TRUE)
writeRaster(ec_filled, 
            filename = file.path(output_dir, "ec_dS_m_0_10cm_CA_270m.tif"), 
            overwrite = TRUE)


# export slope raster
writeRaster(slope_resampled, 
            filename = file.path(output_dir, "slope_deg_CA_270m.tif"), 
            overwrite = TRUE)

# export elevation raster
writeRaster(elevation_ca, 
            filename = file.path(output_dir, "elevation_CA_270m.tif"), 
            overwrite = TRUE)
```

#### WGS84, \~0.00242 degree resolution at equator, SJV extent

Reproject all rasters to WGS 84 (`EPSG:4326`) for use in Wallace.

```{r}
# project all rasters to WGS 84
aet_wgs84 <- project(aet_ca_filled, "EPSG:4326", method = "mean")
ppt_wgs84 <- project(ppt_ca, "EPSG:4326", method = "mean")
cwd_wgs84 <- project(cwd_ca_filled, "EPSG:4326", method = "mean")
clay_wgs84 <- project(clay_filled, "EPSG:4326", method = "mean")
ph_wgs84 <- project(ph_filled, "EPSG:4326", method = "mean")
ec_wgs84 <- project(ec_filled, "EPSG:4326", method = "mean")
slope_wgs84 <- project(slope_resampled, "EPSG:4326", method = "mean")

# confirm all rasters have the same extent and resolution
crs(aet_wgs84) == crs(ppt_wgs84)
crs(aet_wgs84) == crs(clay_wgs84)
crs(aet_wgs84) == crs(ph_wgs84)
crs(aet_wgs84) == crs(ec_wgs84)
crs(aet_wgs84) == crs(slope_wgs84)
crs(aet_wgs84) == crs(cwd_wgs84)

ext(aet_wgs84) == ext(ppt_wgs84)
ext(aet_wgs84) == ext(clay_wgs84)
ext(aet_wgs84) == ext(ph_wgs84)
ext(aet_wgs84) == ext(ec_wgs84)
ext(aet_wgs84) == ext(slope_wgs84)
ext(aet_wgs84) == ext(cwd_wgs84)

res(aet_wgs84) == res(ppt_wgs84)
res(aet_wgs84) == res(clay_wgs84)
res(aet_wgs84) == res(ph_wgs84)
res(aet_wgs84) == res(ec_wgs84)
res(aet_wgs84) == res(slope_wgs84)
res(aet_wgs84) == res(cwd_wgs84)
```

Save the WGS84 rasters.

```{r}
# export BCM rasters in WGS84
writeRaster(aet_wgs84, 
            filename = file.path(output_dir, "WGS84/aet1991_2020_ave_CA_wgs84.tif"), 
            overwrite = TRUE)
writeRaster(ppt_wgs84, 
            filename = file.path(output_dir, "WGS84/ppt1991_2020_ave_CA_wgs84.tif"), 
            overwrite = TRUE)
writeRaster(cwd_wgs84, 
            filename = file.path(output_dir, "WGS84/cwd1991_2020_ave_CA_wgs84.tif"), 
            overwrite = TRUE)

# export gSSURGO rasters in WGS84
writeRaster(clay_wgs84, 
            filename = file.path(output_dir, "WGS84/clay_pct_0_10cm_CA_wgs84.tif"), 
            overwrite = TRUE)
writeRaster(ph_wgs84, 
            filename = file.path(output_dir, "WGS84/ph_0_10cm_CA_wgs84.tif"), 
            overwrite = TRUE)
writeRaster(ec_wgs84, 
            filename = file.path(output_dir, "WGS84/ec_dS_m_0_10cm_CA_wgs84.tif"), 
            overwrite = TRUE)

# export slope raster in WGS84
writeRaster(slope_wgs84, 
            filename = file.path(output_dir, "WGS84/slope_deg_CA_wgs84.tif"), 
            overwrite = TRUE)
```

## Plot some of the historic BCM data

#### Load rasters and boundaries

```{r}
# load SJV boundary for masking
sjv_boundary <- read_sf(here("data/raw/sjv_counties/sjv_counties.shp"))

# transform SJV boundary to EPSG:3310
sjv_boundary <- st_transform(sjv_boundary, crs = crs(ref_raster))
crs(sjv_boundary)
# convert to terra vector
sjv_vect <- vect(sjv_boundary)
```

Make bounding box for plotting aesthetics

```{r}
# convert terra vectors to sf for easier handling
sjv_sf <- st_as_sf(sjv_vect)

## Create expanded bounding box for SJV
sjv_bbox <- st_bbox(sjv_sf)
sjv_buffer <- 0.1
x_expand <- sjv_buffer * (unname(sjv_bbox["xmax"]) - unname(sjv_bbox["xmin"]))
y_expand <- sjv_buffer * (unname(sjv_bbox["ymax"]) - unname(sjv_bbox["ymin"]))

sjv_bbox_expanded <- st_bbox(c(
  xmin = unname(sjv_bbox["xmin"]) - x_expand,
  xmax = unname(sjv_bbox["xmax"]) + x_expand,
  ymin = unname(sjv_bbox["ymin"]) - y_expand,
  ymax = unname(sjv_bbox["ymax"]) + y_expand
), crs = st_crs(sjv_sf))
```



```{r}
# load the 1991-2020 average rasters in EPSG 3310
aet_1991_2020 <- rast(here("data/intermediate/misc/habitat_suitability/env_predictors/baseline/aet1991_2020_ave_CA_270m.tif"))
cwd_1991_2020 <- rast(here("data/intermediate/misc/habitat_suitability/env_predictors/baseline/cwd1991_2020_ave_CA_270m.tif"))
ppt_1991_2020 <- rast(here("data/intermediate/misc/habitat_suitability/env_predictors/baseline/ppt1991_2020_ave_CA_270m.tif"))
tmn_1991_2020 <- rast(here("data/intermediate/misc/habitat_suitability/env_predictors/baseline/tmn1991_2020_ave_CA_270m.tif"))
tmx_1991_2020 <- rast(here("data/intermediate/misc/habitat_suitability/env_predictors/baseline/tmx1991_2020_ave_CA_270m.tif"))

# crop rasters to SJV boundary vect
aet_1991_2020_sjv <- aet_1991_2020 %>%
  crop(sjv_vect) %>%
  mask(sjv_vect)
cwd_1991_2020_sjv <- cwd_1991_2020 %>%
  crop(sjv_vect) %>%
  mask(sjv_vect)
ppt_1991_2020_sjv <- ppt_1991_2020 %>%
  crop(sjv_vect) %>%
  mask(sjv_vect)
tmn_1991_2020_sjv <- tmn_1991_2020 %>%
  crop(sjv_vect) %>%
  mask(sjv_vect)
tmx_1991_2020_sjv <- tmx_1991_2020 %>%
  crop(sjv_vect) %>%
  mask(sjv_vect)
```

```{r}
# plot each raster and then combine into a multi-panel plot
aet_plot <- tm_shape(aet_1991_2020_sjv, bbox = sjv_bbox_expanded) +
  tm_raster(col.scale = tm_scale_continuous(values = "viridis"), 
            col.legend = tm_legend(title = "mm / yr", 
                                   position = tm_pos_in("left", "bottom"))) + 
  tm_title("AET (1991-2020 avg)", 
           position = tm_pos_in("left", "top"), 
           size = 1)

cwd_plot <- tm_shape(cwd_1991_2020_sjv, bbox = sjv_bbox_expanded) +
  tm_raster(col.scale = tm_scale_continuous(values = "viridis"),
            col.legend = tm_legend(title = "mm / yr", 
                                   position = tm_pos_in("left", "bottom"))) + 
  tm_title("CWD (1991-2020 avg)", 
           position = tm_pos_in("left", "top"), 
           size = 1)

ppt_plot <- tm_shape(ppt_1991_2020_sjv, bbox = sjv_bbox_expanded) +
  tm_raster(col.scale = tm_scale_continuous(values = "viridis"),
            col.legend = tm_legend(title = "mm / yr", 
                                   position = tm_pos_in("left", "bottom"))) +
  tm_title("PPT (1991-2020 avg)", 
           position = tm_pos_in("left", "top"), 
           size = 1)

tmn_plot <- tm_shape(tmn_1991_2020_sjv, bbox = sjv_bbox_expanded) +
  tm_raster(col.scale = tm_scale_continuous(values = "viridis"),
            col.legend = tm_legend(title = "°C", 
                                   position = tm_pos_in("left", "bottom"))) +
  tm_title("TMN (1991-2020 avg)", 
           position = tm_pos_in("left", "top"), 
           size = 1)

tmx_plot <- tm_shape(tmx_1991_2020_sjv, bbox = sjv_bbox_expanded) +
  tm_raster(col.scale = tm_scale_continuous(values = "viridis"),
            col.legend = tm_legend(title = "°C", 
                                   position = tm_pos_in("left", "bottom"))) +
  tm_title("TMX (1991-2020 avg)", 
           position = tm_pos_in("left", "top"), 
           size = 1)

combined_plot <- tmap_arrange(aet_plot, cwd_plot, ppt_plot, tmn_plot, tmx_plot, 
                              ncol = 3)
combined_plot
```





