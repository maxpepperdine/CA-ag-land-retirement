---
title: "BNLL habitat suitability prediction plotting & comparison"
format: html
editor_options: 
  chunk_output_type: console
---

```{r}
# clear the environment
rm(list = ls())
```

## Overview/Purpose

This script generates maps of the BNLL habitat suitability predictions. It compares these predictions with the maps generated by [Stewart et al. (2019)](https://doi.org/10.1371/journal.pone.0210766), and generates plots and difference maps comparing the future predictions for our model under various emissions scenarios. 

## Setup

#### Load Packages

```{r}
library(terra)
library(tidyverse)
library(here)
library(sf)
library(tmap)
```

#### Load data

###### Habitat suitability

```{r}
# Fallow SJV model
bnll_fallowSJV <- rast(here("data/intermediate/misc/habitat_suitability/sdm_files/bnll_sdm/4_maxent_predictions/maxent_bnll_pred_masked_lakes.tif"))

# Stewart et al. (2019) model
bnll_stewart <- rast(here("data/raw/habitat_suitability/stewart_2019/G_sila_cont_suit.tif"))
```

###### Misc

```{r}
# load SJV boundary for masking
sjv_boundary <- read_sf(here("data/raw/sjv_counties/sjv_counties.shp"))

# load CA boundary for inset map
ca_boundary <- read_sf(here("data/raw/ca_state/ca_state_boundary_wgs84.shp"))
```

## Comparing our model with Stewart et al. (2019)

#### Alignments checks

Raster math requires matching CRS, extent, and resolution.

```{r}
# check and fix CRS mismatch
if (crs(bnll_stewart) != crs(bnll_fallowSJV)) {
  message("Reprojecting bnll_stewart to match bnll_fallowSJV's CRS...")
  bnll_stewart <- project(bnll_stewart, crs(bnll_fallowSJV))
}

# resample to ensure perfect alignment
if (!identical(ext(bnll_stewart), ext(bnll_fallowSJV)) || 
    !identical(res(bnll_stewart), res(bnll_fallowSJV)) ||
    !identical(dim(bnll_stewart), dim(bnll_fallowSJV))) {
  
  message("Aligning bnll_fallowSJV to bnll_stewart's grid...")
  bnll_stewart <- resample(bnll_stewart, bnll_fallowSJV, method = "mean")
  message("Alignment complete!")
}

# Final verification
stopifnot(
  "Alignment failed - grids still don't match" = 
    identical(dim(bnll_stewart), dim(bnll_fallowSJV))
)
```

#### Make sure all are in `EPSG:3310`

```{r}
# transform SJV boundary to EPSG:3310
sjv_boundary <- st_transform(sjv_boundary, crs = crs(bnll_fallowSJV))
crs(sjv_boundary)
# convert to terra vector
sjv_vect <- vect(sjv_boundary)

# transform CA boundary to EPSG:3310
ca_boundary <- st_transform(ca_boundary, crs = crs(bnll_fallowSJV))
crs(ca_boundary)
# convert to terra vector
ca_vect <- vect(ca_boundary)
```

#### Continuous (raw data) comparisons

Side-by-side plot of the two raw models

```{r}
# Stewart et al. (2019) model
map_stewart <- tm_shape(bnll_stewart) +
  tm_raster(col.scale = tm_scale_continuous(values = "viridis",
                                             ticks = seq(0, 1, by = 0.25)),
            col.legend = tm_legend(title = "Stewart Model")) +
  tm_layout(legend.position = c("left", "bottom"))

# Fallow SJV (our) model
map_fallowSJV <- tm_shape(bnll_fallowSJV) +
  tm_raster(col.scale = tm_scale_continuous(values = "viridis",
                                             ticks = seq(0, 1, by = 0.25)),
            col.legend = tm_legend(title = "FallowSJV Model")) +
  tm_layout(legend.position = c("left", "bottom"))

# combine maps side-by-side
tmap_arrange(map_stewart, map_fallowSJV, ncol = 2)
```

Difference raster map. 

Interpretation:
- **Positive** --> stewart predict higher suitability
- **Negative** --> fallowSJV predict higher suitability
- **~Zero** --> models agree

```{r}
# calculate difference raster
diff_continuous <- bnll_stewart - bnll_fallowSJV

# plot difference raster
map_diff_cont <- tm_shape(diff_continuous) +
  tm_raster(col.scale = tm_scale_continuous(values = "RdBu",
                                             midpoint = 0),
            col.legend = tm_legend(title = "Continuous difference\n(Stewart - FallowSJV)")) +
  tm_layout(legend.position = c("left", "bottom"))
map_diff_cont
```

#### Reclassified comparisons

Threshold: >= 0.8 is classified as suitable (1), < 0.8 is unsuitable (0).

```{r}
# define the reclass matrix
reclass_matrix <- matrix(c(0, 0.7, 0,      # [0, 0.7) -> 0 (unsuitable)
                           0.7, 1, 1),     # [0.7, 1] -> 1 (suitable)
                           ncol = 3, byrow = TRUE)

# reclassify rasters
bnll_stewart_bin <- classify(bnll_stewart, reclass_matrix)
bnll_fallowSJV_bin <- classify(bnll_fallowSJV, reclass_matrix)
```

Side-by-side plot of the two binary models

```{r}
# define palettes 
palette_binary <- c("grey70", "green4")  # grey = not suitable, green = suitable
labels_binary  <- c("Not Suitable", "Suitable")

# Stewart et al. (2019) model
map_stewart_bin <- tm_shape(bnll_stewart_bin) +
  tm_raster(col.scale = tm_scale_categorical(values = palette_binary,
                                              labels = labels_binary),
            col.legend = tm_legend(title = "Stewart model")) +
  tm_layout(legend.position = c("left", "bottom"))

# Fallow SJV (our) model
map_fallowSJV_bin <- tm_shape(bnll_fallowSJV_bin) +
  tm_raster(col.scale = tm_scale_categorical(values = palette_binary,
                                              labels = labels_binary),
            col.legend = tm_legend(title = "FallowSJV model")) +
  tm_layout(legend.position = c("left", "bottom"))

# combine maps side-by-side
tmap_arrange(map_stewart_bin, map_fallowSJV_bin, ncol = 2)
```

Difference raster map (binary).

Interpretation:
- **1** --> Stewart suitable, FallowSJV not suitable (stewart-only)
- **-1** --> FallowSJV suitable, Stewart not suitable (fallowSJV-only)
- **0** --> both models agree (both suitable OR both not suitable)

```{r}
# calculate difference raster
diff_binary <- bnll_stewart_bin - bnll_fallowSJV_bin

# plot difference raster
palette_diff_bin <- c("#e6550d",   # -1  fallowSJV only 
                      "#f0f0f0",   #  0  agreement
                      "#3182bd")   #  1  stewart only

labels_diff_bin <- c("-1 (fallowSJV only)",
                     " 0 (both agree)",
                     " 1 (Stewart only)")

# plot difference raster
map_diff_bin <- tm_shape(diff_binary) +
  tm_raster(col.scale = tm_scale_categorical(values = palette_diff_bin,
                                              labels = labels_diff_bin),
            col.legend = tm_legend(title = "Binary difference\n(Stewart - FallowSJV)")) +
  tm_layout(legend.position = c("left", "bottom"))

map_diff_bin
```

```{r}
# plot the difference rasters side-by-side
tmap_arrange(map_diff_cont, map_diff_bin, ncol = 2)
```

## Comparing future predictions under different emissions scenarios

#### Load & plot the future predictions

```{r}
bnll_baseline <- bnll_fallowSJV

# RCP 4.5 (2020-2049)
bnll_rcp45_2049 <- rast(here("data/intermediate/misc/habitat_suitability/sdm_files/bnll_sdm/4_maxent_predictions/future/maxent_bnll_pred_rcp45_2020_2049_masked_lakes.tif"))

# RCP 4.5 (2040-2069)
bnll_rcp45_2069 <- rast(here("data/intermediate/misc/habitat_suitability/sdm_files/bnll_sdm/4_maxent_predictions/future/maxent_bnll_pred_rcp45_2040_2069_masked_lakes.tif"))

# RCP 8.5 (2020-2049)
bnll_rcp85_2049 <- rast(here("data/intermediate/misc/habitat_suitability/sdm_files/bnll_sdm/4_maxent_predictions/future/maxent_bnll_pred_rcp85_2020_2049_masked_lakes.tif"))

# RCP 8.5 (2040-2069)
bnll_rcp85_2069 <- rast(here("data/intermediate/misc/habitat_suitability/sdm_files/bnll_sdm/4_maxent_predictions/future/maxent_bnll_pred_rcp85_2040_2069_masked_lakes.tif"))
```

#### Calculate continuous difference rasters

```{r}
# calculate the continuous difference rasters (future - baseline)
cont_diff_rcp45_2049 <- bnll_rcp45_2049 - bnll_baseline
cont_diff_rcp45_2069 <- bnll_rcp45_2069 - bnll_baseline
cont_diff_rcp85_2049 <- bnll_rcp85_2049 - bnll_baseline
cont_diff_rcp85_2069 <- bnll_rcp85_2069 - bnll_baseline

# clip to SJV boundary
cont_diff_rcp45_2049_sjv <- cont_diff_rcp45_2049 %>% 
  mask(sjv_vect) %>% 
  crop(sjv_vect)
cont_diff_rcp45_2069_sjv <- cont_diff_rcp45_2069 %>% 
  mask(sjv_vect) %>% 
  crop(sjv_vect)
cont_diff_rcp85_2049_sjv <- cont_diff_rcp85_2049 %>% 
  mask(sjv_vect) %>% 
  crop(sjv_vect)
cont_diff_rcp85_2069_sjv <- cont_diff_rcp85_2069 %>% 
  mask(sjv_vect) %>% 
  crop(sjv_vect)
```

#### Reclassify the future predictions & calculate binary difference rasters

Calculated in `4_maxent_predictions.qmd`, reclassify continuous habitat suitability layers into binary suitable/unsuitable layers using the threshold that maximizes true positive/negative rate (i.e., specificity + sensitivity). This is **0.29** for the BNLL maxent model.

```{r}
# define the reclass matrix
reclass_matrix_future <- matrix(c(0, 0.29, 0,
                                  0.29, 1, 1),
                                ncol = 3, byrow = TRUE)

# reclassify baseline
bnll_baseline_bin <- classify(bnll_baseline, reclass_matrix_future)

# reclassify future predictions
bnll_rcp45_2049_bin <- classify(bnll_rcp45_2049, reclass_matrix_future)
bnll_rcp45_2069_bin <- classify(bnll_rcp45_2069, reclass_matrix_future)
bnll_rcp85_2049_bin <- classify(bnll_rcp85_2049, reclass_matrix_future)
bnll_rcp85_2069_bin <- classify(bnll_rcp85_2069, reclass_matrix_future)

# calculate difference rasters (future - baseline)
bin_diff_rcp45_2049 <- bnll_rcp45_2049_bin - bnll_baseline_bin
bin_diff_rcp45_2069 <- bnll_rcp45_2069_bin - bnll_baseline_bin
bin_diff_rcp85_2049 <- bnll_rcp85_2049_bin - bnll_baseline_bin
bin_diff_rcp85_2069 <- bnll_rcp85_2069_bin - bnll_baseline_bin

# clip difference rasters to SJV boundary
bin_diff_rcp45_2049_sjv <- bin_diff_rcp45_2049 %>% 
  mask(sjv_vect) %>% 
  crop(sjv_vect)
bin_diff_rcp45_2069_sjv <- bin_diff_rcp45_2069 %>% 
  mask(sjv_vect) %>% 
  crop(sjv_vect)
bin_diff_rcp85_2049_sjv <- bin_diff_rcp85_2049 %>% 
  mask(sjv_vect) %>% 
  crop(sjv_vect)
bin_diff_rcp85_2069_sjv <- bin_diff_rcp85_2069 %>% 
  mask(sjv_vect) %>% 
  crop(sjv_vect)
```

#### Plot the future predictions and difference maps

Binary difference maps

```{r}
# convert terra vectors to sf for easier handling
sjv_sf <- st_as_sf(sjv_vect)
ca_sf <- st_as_sf(ca_vect)

## Create expanded bounding box for SJV
sjv_bbox <- st_bbox(sjv_sf)
sjv_buffer <- 0.1
x_expand <- sjv_buffer * (unname(sjv_bbox["xmax"]) - unname(sjv_bbox["xmin"]))
y_expand <- sjv_buffer * (unname(sjv_bbox["ymax"]) - unname(sjv_bbox["ymin"]))

sjv_bbox_expanded <- st_bbox(c(
  xmin = unname(sjv_bbox["xmin"]) - x_expand,
  xmax = unname(sjv_bbox["xmax"]) + x_expand,
  ymin = unname(sjv_bbox["ymin"]) - y_expand,
  ymax = unname(sjv_bbox["ymax"]) + y_expand
), crs = st_crs(sjv_sf))

# Create expanded bounding box for CA
ca_bbox <- st_bbox(ca_sf)
ca_buffer <- 0.1
x_expand_ca <- ca_buffer * (unname(ca_bbox["xmax"]) - unname(ca_bbox["xmin"]))
y_expand_ca <- ca_buffer * (unname(ca_bbox["ymax"]) - unname(ca_bbox["ymin"]))

ca_bbox_expanded <- st_bbox(c(
  xmin = unname(ca_bbox["xmin"]) - x_expand_ca,
  xmax = unname(ca_bbox["xmax"]) + x_expand_ca,
  ymin = unname(ca_bbox["ymin"]) - y_expand_ca,
  ymax = unname(ca_bbox["ymax"]) + y_expand_ca
), crs = st_crs(ca_sf))


# stack the difference rasters and name them
bin_diff_stack <- c(bin_diff_rcp45_2049_sjv, bin_diff_rcp45_2069_sjv, 
                    bin_diff_rcp85_2049_sjv, bin_diff_rcp85_2069_sjv)
names(bin_diff_stack) <- c("RCP 4.5 (2020-2049)", "RCP 4.5 (2040-2069)", 
                           "RCP 8.5 (2020-2049)", "RCP 8.5 (2040-2069)")

# create the binary difference map
main_map <- tm_shape(bin_diff_stack, bbox = sjv_bbox_expanded) +
  
  tm_raster(
    col.scale = tm_scale_categorical(
      values = c("#e6550d", "#f7f7f7", "#3182bd"),
      labels = c("Loss (-1)", "No change (0)", "Gain (+1)")
    ),
    col.legend = tm_legend(title = "Habitat change"), 
    col.free = FALSE
  ) +
  tm_facets_wrap(ncol = 2) +
  tm_layout(
    panel.labels = names(bin_diff_stack)
  ) + 
  tm_shape(sjv_vect) +
  tm_borders(col = "black", lwd = 0.5) +
  tm_facets_wrap(ncol = 2)

# create the inset map
inset_map <- tm_shape(ca_vect, bbox = ca_bbox_expanded) +
  tm_borders(col = "black", lwd=1) +
  tm_shape(sjv_vect) +
  tm_fill(fill = "red", fill_alpha = 0.5) +
  tm_borders(col = "red") +
  tm_layout(frame = TRUE, bg.color = "white")

# print main map
print(main_map)

# add inset using viewport
print(inset_map, vp = grid::viewport(x = 0.75, y = 0.5, width = 0.25, height = 0.3))
```

Continuous difference maps

```{r}
# stack the continuous difference rasters and name them
cont_diff_stack <- c(cont_diff_rcp45_2049_sjv, cont_diff_rcp45_2069_sjv, 
                     cont_diff_rcp85_2049_sjv, cont_diff_rcp85_2069_sjv)
names(cont_diff_stack) <- c("RCP 4.5 (2020-2049)", "RCP 4.5 (2040-2069)", 
                            "RCP 8.5 (2020-2049)", "RCP 8.5 (2040-2069)")

# create the continuous difference map
main_map_cont <- tm_shape(cont_diff_stack, bbox = sjv_bbox_expanded) +
  tm_raster(col.scale = tm_scale_continuous(values = "brewer.rd_bu", midpoint = 0),
            col.legend = tm_legend(
              title = "Change in habitat suitability\n(future - baseline)"), 
            col.free = FALSE) +
  tm_facets_wrap(ncol = 2) +
  tm_layout(panel.labels = names(cont_diff_stack)) +
  tm_shape(sjv_vect) +
  tm_borders(col = "black", lwd = 0.5) +
  tm_facets_wrap(ncol = 2)

# plot main map
print(main_map_cont)

# add inset using viewport
print(inset_map, vp = grid::viewport(x = 0.7, y = 0.3, width = 0.25, height = 0.3))
```

Raw future projections

```{r}
# clip the cont future predictions to SJV boundary
bnll_rcp45_2049_sjv <- bnll_rcp45_2049 %>% 
  mask(sjv_vect) %>% 
  crop(sjv_vect)
bnll_rcp45_2069_sjv <- bnll_rcp45_2069 %>% 
  mask(sjv_vect) %>% 
  crop(sjv_vect)
bnll_rcp85_2049_sjv <- bnll_rcp85_2049 %>% 
  mask(sjv_vect) %>% 
  crop(sjv_vect)
bnll_rcp85_2069_sjv <- bnll_rcp85_2069 %>% 
  mask(sjv_vect) %>% 
  crop(sjv_vect)

# stack the future predictions and name them
future_stack <- c(bnll_rcp45_2049_sjv, bnll_rcp45_2069_sjv, 
                  bnll_rcp85_2049_sjv, bnll_rcp85_2069_sjv)
names(future_stack) <- c("RCP 4.5 (2020-2049)", "RCP 4.5 (2040-2069)", 
                         "RCP 8.5 (2020-2049)", "RCP 8.5 (2040-2069)")

# plot the future predictions
bnll_fut_map <- tm_shape(future_stack, bbox = sjv_bbox_expanded) +
  tm_raster(col.scale = tm_scale_continuous(values = "viridis",
                                             ticks = seq(0, 1, by = 0.25)),
            col.legend = tm_legend(title = "Habitat suitability"), 
            col.free = FALSE) +
  tm_facets_wrap(ncol = 2) +
  tm_layout(panel.labels = names(future_stack))

# plot main map
print(bnll_fut_map)

# add inset using viewport
print(inset_map, vp = grid::viewport(x = 0.73, y = 0.4, width = 0.2, height = 0.25))
```

























