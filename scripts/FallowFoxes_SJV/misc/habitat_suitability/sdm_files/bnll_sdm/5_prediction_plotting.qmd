---
title: "BNLL habitat suitability prediction plotting & comparison"
format: html
editor_options: 
  chunk_output_type: console
---

```{r}
# clear the environment
rm(list = ls())
```

## Overview/Purpose

This script generates maps of the BNLL habitat suitability predictions and compares these predictions with the maps generated by [Stewart et al. (2019)](https://doi.org/10.1371/journal.pone.0210766). 

## Setup

#### Load Packages

```{r}
library(terra)
library(tidyverse)
library(here)
library(sf)
library(tmap)
```

#### Load data

###### Habitat suitability

```{r}
##### Blunt-nosed leopard lizard habitat suitability rasters #####

# Fallow SJV model
bnll_fallowSJV <- rast(here("data/intermediate/misc/habitat_suitability/sdm_files/bnll_sdm/4_maxent_predictions/maxent_bnll_pred_masked_lakes.tif"))

# Stewart et al. (2019) model
bnll_stewart <- rast(here("data/raw/habitat_suitability/stewart_2019/G_sila_cont_suit.tif"))


```

###### Misc

```{r}
# load SJV boundary for masking
sjv_boundary <- read_sf(here("data/raw/sjv_counties/sjv_counties.shp"))
```

## Alignments checks

Raster math requires matching CRS, extent, and resolution.

```{r}
# check and fix CRS mismatch
if (crs(bnll_stewart) != crs(bnll_fallowSJV)) {
  message("Reprojecting bnll_stewart to match bnll_fallowSJV's CRS...")
  bnll_stewart <- project(bnll_stewart, crs(bnll_fallowSJV))
}

# resample to ensure perfect alignment
if (!identical(ext(bnll_stewart), ext(bnll_fallowSJV)) || 
    !identical(res(bnll_stewart), res(bnll_fallowSJV)) ||
    !identical(dim(bnll_stewart), dim(bnll_fallowSJV))) {
  
  message("Aligning bnll_fallowSJV to bnll_stewart's grid...")
  bnll_stewart <- resample(bnll_stewart, bnll_fallowSJV, method = "mean")
  message("Alignment complete!")
}

# Final verification
stopifnot(
  "Alignment failed - grids still don't match" = 
    identical(dim(bnll_stewart), dim(bnll_fallowSJV))
)
```

#### Make sure all are in `EPSG:3310`

```{r}
# transform SJV boundary to EPSG:3310
sjv_boundary <- st_transform(sjv_boundary, crs = crs(bnll_fallowSJV))
crs(sjv_boundary)
# convert to terra vector
sjv_vect <- vect(sjv_boundary)
```

## Plotting our model and the Stewart et al. (2019) model

#### Continuous (raw data) comparisons

Side-by-side plot of the two raw models

```{r}
# Stewart et al. (2019) model
map_stewart <- tm_shape(bnll_stewart) +
  tm_raster(col.scale = tm_scale_continuous(values = "viridis",
                                             ticks = seq(0, 1, by = 0.25)),
            col.legend = tm_legend(title = "Stewart Model")) +
  tm_layout(legend.position = c("left", "bottom"))

# Fallow SJV (our) model
map_fallowSJV <- tm_shape(bnll_fallowSJV) +
  tm_raster(col.scale = tm_scale_continuous(values = "viridis",
                                             ticks = seq(0, 1, by = 0.25)),
            col.legend = tm_legend(title = "FallowSJV Model")) +
  tm_layout(legend.position = c("left", "bottom"))

# combine maps side-by-side
tmap_arrange(map_stewart, map_fallowSJV, ncol = 2)
```

Difference raster map. 

Interpretation:
- **Positive** --> stewart predict higher suitability
- **Negative** --> fallowSJV predict higher suitability
- **~Zero** --> models agree

```{r}
# calculate difference raster
diff_continuous <- bnll_stewart - bnll_fallowSJV

# plot difference raster
map_diff_cont <- tm_shape(diff_continuous) +
  tm_raster(col.scale = tm_scale_continuous(values = "RdBu",
                                             midpoint = 0),
            col.legend = tm_legend(title = "Continuous difference\n(Stewart - FallowSJV)")) +
  tm_layout(legend.position = c("left", "bottom"))
map_diff_cont
```

#### Reclassified comparisons

Threshold: >= 0.8 is classified as suitable (1), < 0.8 is unsuitable (0).

```{r}
# define the reclass matrix
reclass_matrix <- matrix(c(0, 0.7, 0,      # [0, 0.7) -> 0 (unsuitable)
                           0.7, 1, 1),     # [0.7, 1] -> 1 (suitable)
                           ncol = 3, byrow = TRUE)

# reclassify rasters
bnll_stewart_bin <- classify(bnll_stewart, reclass_matrix)
bnll_fallowSJV_bin <- classify(bnll_fallowSJV, reclass_matrix)
```

Side-by-side plot of the two binary models

```{r}
# define palettes 
palette_binary <- c("grey70", "green4")  # grey = not suitable, green = suitable
labels_binary  <- c("Not Suitable", "Suitable")

# Stewart et al. (2019) model
map_stewart_bin <- tm_shape(bnll_stewart_bin) +
  tm_raster(col.scale = tm_scale_categorical(values = palette_binary,
                                              labels = labels_binary),
            col.legend = tm_legend(title = "Stewart model")) +
  tm_layout(legend.position = c("left", "bottom"))

# Fallow SJV (our) model
map_fallowSJV_bin <- tm_shape(bnll_fallowSJV_bin) +
  tm_raster(col.scale = tm_scale_categorical(values = palette_binary,
                                              labels = labels_binary),
            col.legend = tm_legend(title = "FallowSJV model")) +
  tm_layout(legend.position = c("left", "bottom"))

# combine maps side-by-side
tmap_arrange(map_stewart_bin, map_fallowSJV_bin, ncol = 2)
```

Difference raster map (binary).

Interpretation:
- **1** --> Stewart suitable, FallowSJV not suitable (stewart-only)
- **-1** --> FallowSJV suitable, Stewart not suitable (fallowSJV-only)
- **0** --> both models agree (both suitable OR both not suitable)

```{r}
# calculate difference raster
diff_binary <- bnll_stewart_bin - bnll_fallowSJV_bin

# plot difference raster
palette_diff_bin <- c("#e6550d",   # -1  fallowSJV only 
                      "#f0f0f0",   #  0  agreement
                      "#3182bd")   #  1  stewart only

labels_diff_bin <- c("-1 (fallowSJV only)",
                     " 0 (both agree)",
                     " 1 (Stewart only)")

# plot difference raster
map_diff_bin <- tm_shape(diff_binary) +
  tm_raster(col.scale = tm_scale_categorical(values = palette_diff_bin,
                                              labels = labels_diff_bin),
            col.legend = tm_legend(title = "Binary difference\n(Stewart - FallowSJV)")) +
  tm_layout(legend.position = c("left", "bottom"))

map_diff_bin
```

```{r}
# plot the difference rasters side-by-side
tmap_arrange(map_diff_cont, map_diff_bin, ncol = 2)
```









