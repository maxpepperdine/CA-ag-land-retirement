---
title: "Extract environmental data to GKR occurances"
author: "Stella Wing"
format: html
editor: visual
date: last-modified
editor_options: 
  chunk_output_type: console
---

## Overview

This script acquires San Joaquin Kit Fox (SJKF) occurrence points from GBIF using the `rgbif` package, and then extracts environmental data to the GKR occurrence points for use in MaxEnt modeling. The environmental data includes:

-   BCM climate (AET, CWD, PPT)
-   gSSURGO soil data (pH, % clay, % silt, EC)
-   Slope from USGS Open Topography

We will also spatially thin the occurrence points by 1 km to reduce spatial autocorrelation.

```{r}
rm(list=ls())
```

## Load packages

```{r}
library(terra)      # for raster processing
library(tidyverse)  # always
library(sf)         # for spatial data processing
library(here)       # for file paths
library(spThin)     # for spatial thinning
library(rgbif)      # for GBIF data download
```

## Load data

#### Environmental rasters

```{r}
# load all env rasters
env_rasters <- rast(list.files(here("data/baseline/sjkf"), 
                               pattern = ".tif$", 
                               full.names = TRUE))
# fix names
names(env_rasters) <- c("aet1991_2020_ave", "clay_pct_0_10cm", "cwd1991_2020_ave", 
                        "ec_dS_m_0_10cm", "pH_0_10cm", "ppt1991_2020_ave", "slope", "silt_pct_0_10cm") 
plot(env_rasters)
```

#### SJKF occurrences

```{r}
# load occurrence points from GBIF
sjkf_occs <- occ_search(
  taxonKey = 6164308,  # taxon key for Vulpes macrotis mutica
  hasCoordinate = TRUE,
  hasGeospatialIssue = FALSE,
  year = "1990,2025", 
  basisOfRecord = "HUMAN_OBSERVATION;OBSERVATION;MACHINE_OBSERVATION",
  limit = 10000
)

# convert to data frame
sjkf_occ_df <- sjkf_occs$data %>%
  dplyr::select(gbifID, decimalLongitude, decimalLatitude, institutionCode, year, 
         basisOfRecord, scientificName)

# convert occ points to SpatVector
sjkf_occ_vect <- vect(sjkf_occ_df, 
                     geom = c("decimalLongitude", "decimalLatitude"), 
                     crs = "EPSG:4326")

# make sure crs matches env rasters
sjkf_occ_vect <- project(sjkf_occ_vect, crs(env_rasters))

```

```{r}
# checking  occ pointy locations 

# Read shapefile
ca_state <- vect("/Users/stellawing/Desktop/CA-ag-land-retirement/data/ca_state/ca_state_boundary_no_islands.shp")


# Check CRS
crs(ca_state)
crs(sjkf_occ_vect)

# Select one raster layer by name
r <- env_rasters[["ppt1991_2020_ave"]]

# Plot raster
plot(r,
     main = "San Joaquin Kit Fox Occurrences\non Mean Annual Precipitation")

# Add occurrence points
points(sjkf_occ_vect,
       pch = 20,
       col = "red",
       cex = 0.6)

```

#### Spatial thinning of occurrence points

Thin occurrence points to 1 km minimum distance. This reduces spatial autocorrelation and sampling bias.

```{r}
# convert back to lat/lon for spThin (it requires decimal degrees)
sjkf_occ_latlon <- project(sjkf_occ_vect, "EPSG:4326")
sjkf_occ_df <- as.data.frame(sjkf_occ_latlon, geom = "XY")

# run spatial thinning with 1 km distance
# thin.par = 1 means 1 km minimum distance between points
# reps = 100 means run 100 iterations to find best thinning solution
# locs.thinned.list.return = TRUE returns all replicates
# write.files = FALSE prevents writing files automatically
thinned_data <- spThin::thin(
  loc.data = sjkf_occ_df,
  lat.col = "y",  # latitude column
  long.col = "x", # longitude column
  spec.col = "scientificName", 
  thin.par = 1,   # thinning distance in km
  reps = 100,     # number of replications
  locs.thinned.list.return = TRUE,
  write.files = FALSE,
  write.log.file = FALSE
)

# select the thinned dataset with the most points
# (spThin returns a list of different thinning solutions)
max_points <- which.max(sapply(thinned_data, nrow))
sjkf_thinned_df <- thinned_data[[max_points]]

# convert thinned points back to SpatVector and match original CRS
sjkf_thinned_vect <- vect(sjkf_thinned_df, 
                          geom = c("Longitude", "Latitude"), 
                          crs = "EPSG:4326")

# project to match env rasters
sjkf_thinned_vect <- project(sjkf_thinned_vect, crs(env_rasters))
crs(sjkf_thinned_vect)  # check crs
```

## Extract environmental data to occurrence points

```{r}
# extract env data to occ points
sjkf_occ_env <- terra::extract(env_rasters, sjkf_thinned_vect, 
                               bind = TRUE)

# set as sf object
sjkf_occ_env_sf <- st_as_sf(sjkf_occ_env, 
                            coords = c("longitude", "latitude"))

# extract geometry columns as lat/lon
sjkf_occ_env_df <- sjkf_occ_env_sf %>% 
  mutate(longitude = st_coordinates(sjkf_occ_env_sf)[,1],
         latitude = st_coordinates(sjkf_occ_env_sf)[,2], 
         .before = "aet1991_2020_ave") %>%
  st_drop_geometry()
```

## Save the data

```{r}
# save final occurrence points with env data to CSV
write_csv(sjkf_occ_env_df, here("data/sjkf_occ_env_data.csv")) # edit pathway

# save SF object
write_sf(sjkf_occ_env_df, here("data/sjkf_occ_env_data.shp"), # edit pathway
         append = FALSE)
```
