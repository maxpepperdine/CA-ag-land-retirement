---
title: "Processing Env Predictor Variables for SDMs"
format: html
---

```{r}
# clear the environment
rm(list = ls())
```

## Overview/Purpose

This script processes environmental predictor variables for use in species distribution models (SDMs). It will load each of the predictor variables in raster format, ensure they are aligned to a common extent and resolution, and then export the processed rasters for use in modeling.

## Setup

#### Load packages

```{r}
# load required packages
library(terra)
library(here)
library(tidyverse)
library(tigris)
library(sf)
```

#### Load data

```{r}
# ==============================================================================
# BCM data (30-year averages from 1991-2020)
# ==============================================================================

## AET
# file paths for BCM AET monthly average rasters
aet_rast <- rast(here("data/raw/bcm/BCMv8_1991_2020_aves/aet1991_2020_ave.asc"))
crs(aet_rast) <- "EPSG:3310" # assign correct CRS
# QC resolution & crs
res(aet_rast) # 270m resolution
crs(aet_rast) # EPSG:3310

## MAP
ppt_rast <- rast(here("data/raw/bcm/BCMv8_1991_2020_aves/ppt1991_2020_ave.asc"))
crs(ppt_rast) <- "EPSG:3310" # assign correct CRS
# QC resolution & crs
res(ppt_rast) # 270m resolution
crs(ppt_rast) # EPSG:3310


# ==============================================================================
# gSSURGO
# ==============================================================================

## % clay
# file path for gSSURGO % clay raster
clay_path <- here("data/raw/gssurgo/processed/clay_pct_0_10cm_CA_270m.tif")
clay_rast <- rast(clay_path)

## pH
# file path for gSSURGO pH raster
ph_path <- here("data/raw/gssurgo/processed/pH_0_10cm_CA_270m.tif")
ph_rast <- rast(ph_path)

# EC
# file path for gSSURGO EC raster
ec_path <- here("data/raw/gssurgo/processed/ec_dS_m_0_10cm_CA_270m.tif")
ec_rast <- rast(ec_path)


# ==============================================================================
# slope (open topography)
# ==============================================================================

# open topography limits the size of raster downloads
# we have separate elevation rasters for northern and southern CA

# northern CA elevation raster path
nCA_elevation_path <- here("data/raw/open_topography/output_nCA_USGS30m.tif")
nCA_elevation_rast <- rast(nCA_elevation_path)

# southern CA elevation raster path
sCA_elevation_path <- here("data/raw/open_topography/output_sCA_USGS30m.tif")
sCA_elevation_rast <- rast(sCA_elevation_path)
```

## Data Processing

#### BCM

```{r}
# ==============================================================================
# AET
# ==============================================================================

# check the projection, extent, and resolution of the AET stack
crs(aet_stack) # EPSG:3310
ext(aet_stack) 
res(aet_stack) # 270m

# this is already in the desired projection, extent, and resolution
# we will resample/project other layers to match this one

# calculate the mean AET across all months
aet_mean <- mean(aet_stack)
plot(aet_mean, main = "Mean AET")
```

#### Make SJV spat vector

```{r}
# # get California counties from Census TIGER/Line shapefiles
# ca_counties <- counties(state = "CA")
# 
# # define San Joaquin Valley counties
# sjv_counties <- c("San Joaquin", "Stanislaus", "Merced", "Madera", 
#                   "Fresno", "Kings", "Tulare", "Kern")
# 
# # filter and combine into one polygon
# sjv <- ca_counties %>%
#   filter(NAME %in% sjv_counties) %>%
#   st_union() %>% 
#   st_transform(crs = crs(aet_mean)) %>% # transform to aet raster CRS
#   vect() # convert to terra vector format
# 
# # crop AET mean raster to SJV extent
# aet_mean_sjv <- aet_mean %>% 
#   crop(sjv) %>%
#   mask(sjv)
# 
# # plot cropped AET raster
# plot(aet_mean_sjv, main = "Mean AET (SJV)")
```

#### Make CA boundary spat vector

```{r}
# get California state boundary from Census TIGER/Line shapefiles
ca_state <- states() %>%
  filter(NAME == "California") %>%
  st_transform(crs = crs(aet_rast)) %>% # transform to aet raster CRS
  vect() # convert to terra vector format
plot(ca_state, main = "California State Boundary")
```

#### BCM

###### Crop `PPT` and `AET` to CA boundary

```{r}
# crop AET raster to CA boundary
aet_ca <- aet_rast %>%
  crop(ca_state) %>%
  mask(ca_state)

# view range of AET values in CA
summary(values(aet_ca))
# -9999 indicates no data values -- these should be NA
values(aet_ca)[values(aet_ca) == -9999] <- NA


# crop PPT raster to CA boundary
ppt_ca <- ppt_rast %>%
  crop(ca_state) %>%
  mask(ca_state)
# -9999 also indicates no data values -- these should be NA
values(ppt_ca)[values(ppt_ca) == -9999] <- NA

# view range of PPT values in CA
summary(values(ppt_ca))

# plot cropped rasters
plot(aet_ca, main = "AET (CA Boundary)")
plot(ppt_ca, main = "PPT (CA Boundary)")
```

###### Fill NA values in AET raster

The AET raster has some NA values in small areas. This causes errors in `Wallace`. We will fill these values with the mean value of neighboring cells.

```{r}
# define function to fill NA values with mean of neighboring cells
fill_all_na <- function(raster, max_iter = 100) {
  r <- raster
  for (i in 1:max_iter) {
    if (!any(is.na(values(r)))) break
    r <- focal(r, 
               w = 3,                # 3x3 moving window
               fun = mean, 
               na.rm = TRUE,         # ignore NAs in calculation
               na.policy = "only")   # only replace NA cells, leave others as is
  }
  return(r)
}

# apply function to AET raster
aet_ca_filled <- fill_all_na(aet_ca)

# crop to PPT to ensure no edge effects
aet_ca_filled <- aet_ca_filled %>%
  crop(ppt_ca) %>%
  mask(ppt_ca)

# resample ppt to match aet extent
ppt_ca <- resample(ppt_ca, 
                   aet_ca_filled, 
                   method = "mean")

# QC make sure aet and ppt have same extent and resolution
crs(aet_ca_filled) == crs(ppt_ca)
ext(aet_ca_filled) == ext(ppt_ca)
res(aet_ca_filled) == res(ppt_ca)

# plot final AET raster
plot(aet_ca_filled, main = "Mean AET (filled NA values)")
```

#### gSSURGO

Resample gSSURGO rasters to match AET `ext`, `res`, and `crs`.

```{r}
# resample gSSURGO rasters to match AET
clay_resampled <- resample(clay_rast, 
                           aet_ca_filled, 
                           method = "mean")
ph_resampled <- resample(ph_rast, 
                         aet_ca_filled, 
                         method = "mean")
ec_resampled <- resample(ec_rast, 
                         aet_ca_filled, 
                         method = "mean")

# confirm all rasters have the same extent and resolution
crs(clay_resampled) == crs(aet_ca_filled)
crs(ph_resampled) == crs(aet_ca_filled)
crs(ec_resampled) == crs(aet_ca_filled)

ext(clay_resampled) == ext(aet_ca_filled)
ext(ph_resampled) == ext(aet_ca_filled)
ext(ec_resampled) == ext(aet_ca_filled)

res(clay_resampled) == res(aet_ca_filled)
res(ph_resampled) == res(aet_ca_filled)
res(ec_resampled) == res(aet_ca_filled)
```

The gSSURGO data has a lot of NA values in some areas. This causes errors in `Wallace`. We might fill these values with other data later, but for now we will fill them with the mean value of neighboring cells.

```{r}
# apply fill NA function to gSSURGO rasters
clay_filled <- fill_all_na(clay_resampled)
ph_filled <- fill_all_na(ph_resampled)
ec_filled <- fill_all_na(ec_resampled)

# crop to aet raster to ensure no edge effects
clay_filled <- clay_filled %>% 
  crop(aet_ca_filled) %>%
  mask(aet_ca_filled)
ph_filled <- ph_filled %>% 
  crop(aet_ca_filled) %>%
  mask(aet_ca_filled)
ec_filled <- ec_filled %>% 
  crop(aet_ca_filled) %>%
  mask(aet_ca_filled)

# make sure all rasters have the same extent and resolution
crs(clay_filled) == crs(aet_ca_filled)
crs(ph_filled) == crs(aet_ca_filled)
crs(ec_filled) == crs(aet_ca_filled)

ext(clay_filled) == ext(aet_ca_filled)
ext(ph_filled) == ext(aet_ca_filled)
ext(ec_filled) == ext(aet_ca_filled)

res(clay_filled) == res(aet_ca_filled)
res(ph_filled) == res(aet_ca_filled)
res(ec_filled) == res(aet_ca_filled)

# plot filled gSSURGO rasters
plot(clay_filled, main = "% Clay (filled NA values)")
plot(ph_filled, main = "pH (filled NA values)")
plot(ec_filled, main = "EC (filled NA values)")
```


#### Slope

```{r}
# check the projection, extent, and resolution of the elevation raster
crs(elevation_rast) # EPSG:4326
ext(elevation_rast)
res(elevation_rast) # 30m


# project elevation rasters to match AET
nCA_elevation_proj <- project(nCA_elevation_rast, 
                              aet_ca_filled, 
                              method = "mean")
crs(nCA_elevation_proj) # confirm EPSG:3310

sCA_elevation_proj <- project(sCA_elevation_rast, 
                              aet_ca_filled, 
                              method = "mean")
crs(sCA_elevation_proj) # confirm EPSG:3310  

# resample southern CA elevation to match northern CA elevation
sCA_elevation_resampled <- resample(sCA_elevation_proj, 
                                    nCA_elevation_proj, 
                                    method = "mean")


# merge northern and southern CA elevation rasters
elevation_merged <- terra::merge(nCA_elevation_proj, sCA_elevation_resampled)

# crop to CA
elevation_ca <- elevation_merged %>%
  crop(aet_ca_filled) %>%
  mask(aet_ca_filled)
plot(elevation_ca, main = "Elevation (CA Boundary)")


# calculate slope from elevation
slope_rast <- terrain(elevation_ca, 
                      v = "slope", 
                      unit = "degrees")

# resample to match AET resolution and extent
slope_resampled <- resample(slope_rast, 
                            aet_ca_filled, 
                            method = "mean")
plot(slope_resampled, main = "Elevation")


# confirm all rasters have the same extent and resolution
crs(slope_resampled) == crs(aet_ca_filled)
ext(slope_resampled) == ext(aet_ca_filled)
res(slope_resampled) == res(aet_ca_filled)
```

## Export Processed Rasters

#### EPSG:3310, 270m resolution, SJV extent

```{r}
# path to output directory
output_dir <- here("data/intermediate/misc/habitat_suitability/env_predictors/")

# export AET raster
writeRaster(aet_ca_filled, 
            filename = file.path(output_dir, "aet1991_2020_ave_CA_270m.tif"), 
            overwrite = TRUE)

# explort PPT raster
writeRaster(ppt_ca, 
            filename = file.path(output_dir, "ppt1991_2020_ave_CA_270m.tif"), 
            overwrite = TRUE)

# export gSSURGO rasters
writeRaster(clay_filled, 
            filename = file.path(output_dir, "clay_pct_0_10cm_CA_270m.tif"), 
            overwrite = TRUE)
writeRaster(ph_filled, 
            filename = file.path(output_dir, "ph_0_10cm_CA_270m.tif"), 
            overwrite = TRUE)
writeRaster(ec_filled, 
            filename = file.path(output_dir, "ec_dS_m_0_10cm_CA_270m.tif"), 
            overwrite = TRUE)

# export slope raster
writeRaster(slope_resampled, 
            filename = file.path(output_dir, "slope_deg_CA_270m.tif"), 
            overwrite = TRUE)
```

#### WGS84, ~0.00242 degree resolution at equator, SJV extent

Reproject all rasters to WGS 84 (EPSG:4326) for use in Wallace.

```{r}
# project all rasters to WGS 84
aet_wgs84 <- project(aet_ca_filled, 
                     "EPSG:4326", 
                     method = "mean")
ppt_wgs84 <- project(ppt_ca, 
                     "EPSG:4326", 
                     method = "mean")
clay_wgs84 <- project(clay_filled, 
                      "EPSG:4326", 
                      method = "mean")
ph_wgs84 <- project(ph_filled, 
                    "EPSG:4326", 
                    method = "mean")
ec_wgs84 <- project(ec_filled, 
                    "EPSG:4326", 
                    method = "mean")
slope_wgs84 <- project(slope_resampled, 
                       "EPSG:4326", 
                       method = "mean")

# confirm all rasters have the same extent and resolution
crs(aet_wgs84) == crs(ppt_wgs84)
crs(aet_wgs84) == crs(clay_wgs84)
crs(aet_wgs84) == crs(ph_wgs84)
crs(aet_wgs84) == crs(ec_wgs84)
crs(aet_wgs84) == crs(slope_wgs84)
ext(aet_wgs84) == ext(ppt_wgs84)
ext(aet_wgs84) == ext(clay_wgs84)
ext(aet_wgs84) == ext(ph_wgs84)
ext(aet_wgs84) == ext(ec_wgs84)
ext(aet_wgs84) == ext(slope_wgs84)
res(aet_wgs84) == res(ppt_wgs84)
res(aet_wgs84) == res(clay_wgs84)
res(aet_wgs84) == res(ph_wgs84)
res(aet_wgs84) == res(ec_wgs84)
res(aet_wgs84) == res(slope_wgs84)
```

Save the WGS84 rasters.

```{r}
# export BCM rasters in WGS84
writeRaster(aet_wgs84, 
            filename = file.path(output_dir, "WGS84/aet1991_2020_ave_CA_wgs84.tif"), 
            overwrite = TRUE)
writeRaster(ppt_wgs84, 
            filename = file.path(output_dir, "WGS84/ppt1991_2020_ave_CA_wgs84.tif"), 
            overwrite = TRUE)

# export gSSURGO rasters in WGS84
writeRaster(clay_wgs84, 
            filename = file.path(output_dir, "WGS84/clay_pct_0_10cm_CA_wgs84.tif"), 
            overwrite = TRUE)
writeRaster(ph_wgs84, 
            filename = file.path(output_dir, "WGS84/ph_0_10cm_CA_wgs84.tif"), 
            overwrite = TRUE)
writeRaster(ec_wgs84, 
            filename = file.path(output_dir, "WGS84/ec_dS_m_0_10cm_CA_wgs84.tif"), 
            overwrite = TRUE)

# export slope raster in WGS84
writeRaster(slope_wgs84, 
            filename = file.path(output_dir, "WGS84/slope_deg_CA_wgs84.tif"), 
            overwrite = TRUE)
```











